---
import Layout from "@layouts/Layout.astro";
import { db, postEdits } from "@lib/db";
import { eq, desc } from "drizzle-orm";
import { marked } from "marked";

const { slug } = Astro.params;
const [post] = await db
  .select()
  .from(postEdits)
  .where(eq(postEdits.slug, slug))
  .orderBy(desc(postEdits.publishedAt))
  .limit(1);
if (!post) return Astro.redirect(`/blog/${slug}/edit`);

const [{ firstPublishedAt }] = await db
  .select({ firstPublishedAt: postEdits.publishedAt })
  .from(postEdits)
  .where(eq(postEdits.slug, slug))
  .orderBy(postEdits.publishedAt)
  .limit(1);
const gotUpdated = firstPublishedAt.valueOf() !== post.publishedAt.valueOf();

const formatDate = (date: Date) =>
  date.toLocaleString("en-GB", {
    dateStyle: "medium",
    timeStyle: "short",
  });
---

<Layout title={post.title}>
  <header>
    published {formatDate(firstPublishedAt)}{
      gotUpdated && `, last updated ${formatDate(post.publishedAt)}`
    }
  </header>
  <article set:html={marked.parse(post.content)} />
</Layout>

<style>
  header {
    font-size: 0.8em;
  }
</style>
